<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>인생네컷 웹캠 부스</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CSS CDN (필요 없으면 커스텀 CSS로 교체 가능) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- gif.js (GIF 생성용 라이브러리) -->
    <script src="./assets/gif/gif.js"></script>

    <style>
      body {
        background: #f9fafb;
      }

      .page {
        display: none;
      }
      .page.active {
        display: flex;
      }

      /* 첫 페이지에만 배경 이미지 적용 */
      #page-1 {
        background-image: url('./assets/imgs/main_background.png');
        background-size: contain;
        background-position: center center;
        background-repeat: no-repeat;
        background-attachment: scroll;
        min-height: 100vh;
        width: 100%;
        position: relative;
      }

      #page-1 button#startBtn,
      #page-1 a {
        transform: translate(84px, 36px); /* 오른쪽 16px, 아래 24px */
      }

      /* 4컷 스트립 캔버스 */
      #stripCanvas {
        max-width: 100%;
        width: 600px;
        height: auto; /* 비율은 내부 캔버스 해상도 기준으로 자동 */
        display: block;
      }

      /* 로딩 스피너 */
      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #111827;
        border-radius: 9999px;
        width: 3rem;
        height: 3rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* GIF 캔버스 (스냅샷용) */
      #gifFrameCanvas {
        display: none;
      }

      /* 앱 컨테이너 스타일 */
      #app {
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      /* 촬영 화면 비디오 컨테이너 */
      #videoContainer {
        width: 600px;
        aspect-ratio: 4 / 3;
        max-width: 100%;
      }

      /* 태블릿, 모바일 사이즈에서 좌우 마진 80px */
      @media (max-width: 1024px) {
        #app {
          margin-left: 80px;
          margin-right: 80px;
        }

        #videoContainer {
          width: calc(100vw - 160px); /* 좌우 여백 80px씩 */
          height: calc((100vw - 160px) * 180 / 240); /* 240:180 비율 유지 */
        }
      }

      /* 작은 모바일에서도 80px 마진 유지 */
      @media (max-width: 480px) {
        #app {
          margin-left: 80px;
          margin-right: 80px;
        }

        #videoContainer {
          width: calc(100vw - 160px);
          height: calc((100vw - 160px) * 180 / 240);
        }
      }

      #frameSelectorWrapper {
        width: 100%;
        max-width: 600px; /* 웹캠과 동일한 최대 폭 */
        margin: 0 auto;
      }

      /* ✅ 한 줄, 균등 분배 */
      #frameSelector {
        display: flex;
        gap: 8px;
        width: 100%;
      }

      /* 버튼 공통 스타일은 JS에서 className으로 넣어도 되고, 이렇게 해도 됨 */
      #frameSelector button {
        flex: 1 1 0; /* 남은 공간을 균등 분배 */
        aspect-ratio: 4 / 3; /* 4:3 비율 유지 */
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center">
    <div id="app" class="w-full p-4">
      <!-- ====== PAGE 1 : INTRO ====== -->
      <section
        id="page-1"
        class="page active flex-col items-center justify-center text-center gap-6"
      >
        <button
          id="startBtn"
          class="mt-4 inline-flex items-center justify-center px-6 py-3 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800"
        >
          촬영 시작하기
        </button>
      </section>

      <!-- ====== PAGE 2 : CAPTURE ====== -->
      <section
        id="page-2"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold mb-2">촬영 중</h2>
        <p id="captureStatus" class="text-xs text-gray-500 text-center mb-2">
          카메라 준비 중입니다...
        </p>

        <div
          id="videoContainer"
          class="relative bg-black rounded-2xl overflow-hidden flex items-center justify-center mx-auto"
        >
          <img
            id="overlaySample"
            src="./assets/frames/004.png"
            alt="샘플 오버레이"
            class="absolute top-0 h-full w-auto pointer-events-none select-none opacity-90 z-20 object-contain"
          />
          <video
            id="video"
            autoplay
            playsinline
            class="relative z-10 w-full h-full object-cover"
            style="transform: scaleX(-1)"
          ></video>
        </div>

        <!-- 프레임 선택 영역 (웹캠 아래) -->
        <!-- 웹캠 아래 -->
        <div class="mt-3 w-full">
          <p class="text-[11px] text-gray-500 mb-1">프레임을 선택해주세요.</p>

          <!-- ✅ 600px 안에서 전체 폭 사용 -->
          <div id="frameSelectorWrapper" class="w-full max-w-[600px] mx-auto">
            <div id="frameSelector"></div>
          </div>
        </div>

        <!-- 카운트다운 오버레이 -->
        <div
          id="countdownOverlay"
          class="pointer-events-none fixed inset-0 flex items-center justify-center text-white text-6xl font-bold bg-black/40 opacity-0 transition-opacity z-30"
        ></div>
        <div
          id="flashOverlay"
          class="pointer-events-none fixed inset-0 bg-white opacity-0 transition-opacity duration-150 z-40 hidden"
        ></div>

        <button
          id="captureStartBtn"
          class="mt-3 inline-flex items-center justify-center px-5 py-2.5 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          촬영 시작
        </button>

        <p class="text-[11px] text-gray-400 mt-1 text-center">
          촬영 버튼을 누르면 3초 카운트다운 이후 한 장을 촬영하고,
          <br />
          동시에 GIF용 스냅샷도 함께 저장합니다.
        </p>

        <!-- 캡처용 숨김 캔버스 -->
        <canvas id="captureCanvas" class="hidden"></canvas>
        <canvas id="gifFrameCanvas"></canvas>
      </section>

      <!-- ====== PAGE 3 : LOADING ====== -->
      <section
        id="page-3"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold">사진을 합성하는 중이에요</h2>
        <p class="text-xs text-gray-500 text-center">
          1컷 이미지를 만들고 GIF를 생성하고 있어요.
          <br />
          조금만 기다려 주세요.
        </p>

        <div class="spinner mt-2"></div>

        <div class="mt-4 flex flex-col items-center gap-2">
          <p class="text-xs text-gray-500">GIF 미리보기</p>
          <img
            id="loadingGifPreview"
            src=""
            alt="GIF Preview"
            class="w-32 object-cover rounded-xl bg-gray-200 hidden"
            style="aspect-ratio: 240 / 180"
          />
        </div>

        <p id="progressText" class="mt-2 text-[11px] text-gray-400">
          준비 중...
        </p>

        <button
          id="goResultBtn"
          class="mt-4 px-5 py-2.5 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          결과 보러가기
        </button>
      </section>

      <!-- ====== PAGE 4 : RESULT ====== -->
      <section
        id="page-4"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold">완성된 인생한컷</h2>

        <!-- 1컷 스트립 -->
        <div class="w-full flex justify-center">
          <div
            class="bg-white rounded-2xl border border-gray-200 p-3 shadow-sm"
            style="width: 600px; max-width: 100%"
          >
            <canvas id="stripCanvas"></canvas>
          </div>
        </div>

        <!-- GIF -->
        <div class="flex flex-col items-center gap-2 mt-2">
          <p class="text-xs text-gray-500">GIF 애니메이션</p>
          <img
            id="resultGif"
            src=""
            alt="Result GIF"
            class="w-32 object-cover rounded-xl bg-gray-200"
            style="aspect-ratio: 240 / 180"
          />
        </div>

        <!-- ✅ QR 코드 영역 추가 -->
        <div class="mt-4 flex flex-col items-center gap-2">
          <p class="text-xs text-gray-500">결과 이미지 QR 코드</p>
          <div
            id="qrContainer"
            class="w-32 h-32 flex items-center justify-center bg-white rounded-xl border border-gray-200"
          ></div>
          <button
            id="copyLinkBtn"
            class="mt-1 px-3 py-1.5 rounded-full bg-gray-900 text-white text-[11px] font-medium hover:bg-gray-700"
          >
            링크 복사
          </button>
        </div>

        <!-- 버튼들 -->
        <div class="mt-4 flex flex-wrap justify-center gap-2">
          <button
            id="downloadStripBtn"
            class="px-4 py-2 rounded-full bg-black text-white text-xs font-medium hover:bg-gray-800"
          >
            1컷 이미지 다운로드
          </button>
          <button
            id="downloadGifBtn"
            class="px-4 py-2 rounded-full bg-white border border-gray-300 text-xs font-medium hover:bg-gray-50"
          >
            GIF 다운로드
          </button>
          <button
            id="shareBtn"
            class="px-4 py-2 rounded-full bg-blue-500 text-white text-xs font-medium hover:bg-blue-600"
          >
            공유하기
          </button>
        </div>

        <button
          id="restartBtn"
          class="mt-4 px-4 py-2 rounded-full bg-gray-100 text-xs text-gray-600 hover:bg-gray-200"
        >
          다시 찍기
        </button>
      </section>
    </div>

    <script>
      // =========================
      // 글로벌 상태
      // =========================
      const PAGES = {
        INTRO: 1,
        CAPTURE: 2,
        LOADING: 3,
        RESULT: 4,
      };

      const TOTAL_CUTS = 1; // 싱글 샷
      const CUT_INTERVAL_MS = 3000; // 각 컷 사이 간격 (3초)
      const GIF_SNAPSHOT_INTERVAL_MS = 500; // GIF 프레임 간격 (0.5초)

      // 사용자가 선택할 수 있는 프레임 후보들
      const FRAME_OPTIONS = [
        './assets/frames/002.png',
        './assets/frames/003.png',
        './assets/frames/004.png',
        './assets/frames/005.png',
      ];

      // 각 촬영별 오버레이 이미지 (1컷이라 FRAME_OPTIONS와 동일하게 사용)
      const SAMPLE_OVERLAY_IMAGES = FRAME_OPTIONS;

      // 프레임 이미지 설정
      const FRAME_BACKGROUND_IMAGE = null;
      const FRAME_IMAGES = null;

      let currentPage = PAGES.INTRO;
      let stream = null;
      let capturedCuts = []; // [{image: Image}]
      let gifFrames = []; // [HTMLCanvasElement]
      let gifUrl = null; // object URL
      let stripImageUrl = null;
      let frameBackgroundImg = null; // 로드된 배경 프레임 이미지
      let frameImages = []; // 로드된 개별 프레임 이미지 배열
      let sampleOverlayImages = []; // 프레임 후보 이미지 배열
      let currentCaptureIndex = 0; // 현재 촬영 인덱스 (0)
      let currentFrameIndex = 0; // 현재 선택된 프레임 인덱스

      // DOM
      const pageElements = {
        1: document.getElementById('page-1'),
        2: document.getElementById('page-2'),
        3: document.getElementById('page-3'),
        4: document.getElementById('page-4'),
      };

      const startBtn = document.getElementById('startBtn');
      const captureStartBtn = document.getElementById('captureStartBtn');
      const restartBtn = document.getElementById('restartBtn');

      const video = document.getElementById('video');
      const captureCanvas = document.getElementById('captureCanvas');
      const gifFrameCanvas = document.getElementById('gifFrameCanvas');

      const countdownOverlay = document.getElementById('countdownOverlay');
      const flashOverlay = document.getElementById('flashOverlay');
      const captureStatus = document.getElementById('captureStatus');

      const stripCanvas = document.getElementById('stripCanvas');
      const loadingGifPreview = document.getElementById('loadingGifPreview');
      const progressText = document.getElementById('progressText');
      const goResultBtn = document.getElementById('goResultBtn');

      const resultGif = document.getElementById('resultGif');
      const downloadStripBtn = document.getElementById('downloadStripBtn');
      const downloadGifBtn = document.getElementById('downloadGifBtn');
      const shareBtn = document.getElementById('shareBtn');

      const capturedPreviewContainer =
        document.getElementById('capturedPreview');

      const overlaySampleEl = document.getElementById('overlaySample');
      const frameSelector = document.getElementById('frameSelector');

      const qrContainer = document.getElementById('qrContainer');
      const copyLinkBtn = document.getElementById('copyLinkBtn');
      let uploadedImageUrl = null; // S3에 업로드된 최종 이미지 URL

      copyLinkBtn.addEventListener('click', async () => {
        if (!uploadedImageUrl) {
          alert('아직 업로드된 링크가 없어요.');
          return;
        }

        try {
          await navigator.clipboard.writeText(uploadedImageUrl);
          alert('링크가 클립보드에 복사되었습니다.');
        } catch (e) {
          console.error(e);
          alert('복사에 실패했어요. 수동으로 복사해 주세요.');
        }
      });

      function dataURLToBlob(dataURL) {
        const arr = dataURL.split(',');
        const mimeMatch = arr[0].match(/:(.*?);/);
        const mime = mimeMatch ? mimeMatch[1] : 'image/png';
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
      }

      async function uploadStripToS3() {
        if (!stripImageUrl) {
          console.warn('stripImageUrl이 없습니다. 업로드를 건너뜁니다.');
          return null;
        }

        try {
          // 1) 우리 서버에서 presigned URL + 결과 URL 받아오기
          const res = await fetch(
            'https://web-camera-backend.vercel.app/api/upload-url',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ fileType: 'image/png' }),
            }
          );

          if (!res.ok) {
            console.error('업로드 URL 요청 실패', res.status);
            return null;
          }

          const { uploadUrl, fileUrl } = await res.json();

          // 2) dataURL → Blob 변환
          const blob = dataURLToBlob(stripImageUrl);

          // 3) presigned URL로 S3에 업로드 (PUT)
          const putRes = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
              'Content-Type': 'image/png',
            },
            body: blob,
          });

          if (!putRes.ok) {
            console.error('S3 업로드 실패', putRes.status);
            return null;
          }

          console.log('S3 업로드 성공:', fileUrl);
          return fileUrl;
        } catch (e) {
          console.error('업로드 중 오류', e);
          return null;
        }
      }

      function renderQrCode(url) {
        if (!qrContainer) return;
        qrContainer.innerHTML = ''; // 기존 QR 제거

        if (!url) {
          qrContainer.textContent = 'URL 없음';
          return;
        }

        new QRCode(qrContainer, {
          text: url,
          width: 128,
          height: 128,
        });
      }

      goResultBtn.addEventListener('click', () => {
        if (gifUrl) {
          resultGif.src = gifUrl;
        }

        // ✅ S3 업로드된 URL이 있다면 QR 생성
        if (uploadedImageUrl) {
          renderQrCode(uploadedImageUrl);
        } else {
          renderQrCode(null);
        }

        goToPage(PAGES.RESULT);
      });

      function addCapturedPreview(image) {
        if (!capturedPreviewContainer || !image) return;

        const wrapper = document.createElement('div');
        wrapper.className =
          'w-20 flex-shrink-0 overflow-hidden rounded-md border border-gray-300 bg-white shadow-sm';
        wrapper.style.aspectRatio = '240 / 180';

        const thumb = document.createElement('img');
        thumb.src = image.src;
        thumb.className = 'w-full h-full object-cover';

        wrapper.appendChild(thumb);
        capturedPreviewContainer.appendChild(wrapper);
      }

      // =========================
      // 프레임 선택 UI 렌더링
      // =========================
      function renderFrameSelector() {
        if (!frameSelector) return;
        frameSelector.innerHTML = '';

        FRAME_OPTIONS.forEach((src, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';

          // ✅ flex 컨테이너에서 균등 분배 + 4:3 비율
          btn.className = 'relative rounded-md border bg-white overflow-hidden';
          btn.style.flex = '1 1 0';
          btn.style.aspectRatio = '4 / 3';

          if (idx === currentFrameIndex) {
            btn.classList.add('ring-2', 'ring-black');
          }

          const img = document.createElement('img');
          img.src = src;
          img.alt = `프레임 ${idx + 1}`;
          img.className = 'w-full h-full object-cover';

          btn.appendChild(img);

          btn.addEventListener('click', () => {
            currentFrameIndex = idx;
            if (overlaySampleEl) overlaySampleEl.src = src;
            renderFrameSelector();
          });

          frameSelector.appendChild(btn);
        });
      }

      // =========================
      // 페이지 전환
      // =========================
      function goToPage(pageNumber) {
        currentPage = pageNumber;
        Object.entries(pageElements).forEach(([page, el]) => {
          if (Number(page) === pageNumber) el.classList.add('active');
          else el.classList.remove('active');
        });
      }

      // =========================
      // 카메라 시작
      // =========================
      async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('이 브라우저에서는 웹캠을 사용할 수 없습니다.');
          captureStatus.textContent = '웹캠을 사용할 수 없는 환경입니다.';
          return;
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' },
            audio: false,
          });
          video.srcObject = stream;
          captureStatus.textContent =
            '카메라 준비 완료! 촬영 버튼을 눌러주세요.';
          captureStartBtn.disabled = false;

          currentCaptureIndex = 0;
          currentFrameIndex = 0;
          if (overlaySampleEl && FRAME_OPTIONS.length > 0) {
            overlaySampleEl.src = FRAME_OPTIONS[0];
          }
          renderFrameSelector();
        } catch (err) {
          console.error(err);
          alert('카메라 권한을 허용해 주세요.');
          captureStatus.textContent = '카메라 권한이 필요합니다.';
        }
      }

      // =========================
      // 단일 프레임 캡처 (정지컷)
      // =========================
      function captureStillFrame() {
        if (!video.videoWidth || !video.videoHeight) {
          console.warn('비디오가 아직 준비되지 않았습니다.');
          return null;
        }

        const w = video.videoWidth;
        const h = video.videoHeight;

        captureCanvas.width = w;
        captureCanvas.height = h;

        const ctx = captureCanvas.getContext('2d');

        // 1) 비디오 (좌우 반전)
        ctx.save();
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, w, h);
        ctx.restore();

        // 2) 선택된 프레임 이미지 오버레이
        const overlayImg =
          sampleOverlayImages[currentFrameIndex] || sampleOverlayImages[0];
        if (overlayImg) {
          ctx.drawImage(overlayImg, 0, 0, w, h);
        }

        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = w;
        frameCanvas.height = h;
        frameCanvas.getContext('2d').drawImage(captureCanvas, 0, 0);

        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => {
            console.warn('캡처 이미지 로드 실패');
            resolve(null);
          };
          img.src = frameCanvas.toDataURL('image/png');
        });
      }

      // =========================
      // GIF 프레임 캡처
      // =========================
      function captureGifFrame() {
        if (!video.videoWidth || !video.videoHeight) return;

        const w = video.videoWidth;
        const h = video.videoHeight;

        gifFrameCanvas.width = w;
        gifFrameCanvas.height = h;

        const ctx = gifFrameCanvas.getContext('2d');

        // 1) 비디오 (좌우 반전)
        ctx.save();
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, w, h);
        ctx.restore();

        // 2) 선택된 프레임 이미지 오버레이
        const overlayImg =
          sampleOverlayImages[currentFrameIndex] || sampleOverlayImages[0];
        if (overlayImg) {
          ctx.drawImage(overlayImg, 0, 0, w, h);
        }

        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = w;
        frameCanvas.height = h;
        frameCanvas.getContext('2d').drawImage(gifFrameCanvas, 0, 0);
        gifFrames.push(frameCanvas);
      }

      // =========================
      // 카운트다운 표시
      // =========================
      function showCountdown(seconds) {
        return new Promise((resolve) => {
          let n = seconds;
          countdownOverlay.textContent = n;
          countdownOverlay.style.opacity = '1';

          const tick = () => {
            setTimeout(() => {
              n--;
              if (n <= 0) {
                countdownOverlay.style.opacity = '0';
                countdownOverlay.textContent = '';
                resolve();
              } else {
                countdownOverlay.textContent = n;
                tick();
              }
            }, 1000);
          };
          tick();
        });
      }

      function flashScreen(duration = 120) {
        return new Promise((resolve) => {
          if (!flashOverlay) {
            resolve();
            return;
          }
          flashOverlay.classList.remove('hidden');
          flashOverlay.style.opacity = '1';
          setTimeout(() => {
            flashOverlay.style.opacity = '0';
            setTimeout(() => {
              flashOverlay.classList.add('hidden');
              resolve();
            }, 150);
          }, duration);
        });
      }

      // =========================
      // 자동 촬영 (1컷)
      // =========================
      async function startAutoCaptureSession() {
        captureStartBtn.disabled = true;
        capturedCuts = [];
        gifFrames = [];

        captureStatus.textContent =
          '촬영 중입니다. 움직이면서 포즈를 바꿔보세요!';

        const gifIntervalId = setInterval(
          captureGifFrame,
          GIF_SNAPSHOT_INTERVAL_MS
        );

        for (let i = 0; i < TOTAL_CUTS; i++) {
          currentCaptureIndex = i;

          captureStatus.textContent = `${i + 1}번째 사진 촬영 준비...`;
          await showCountdown(3);

          await flashScreen();
          const img = await captureStillFrame();
          if (img) {
            capturedCuts.push(img);
            addCapturedPreview(img);
            console.log(
              `${i + 1}번째 사진 촬영 완료. 총 ${capturedCuts.length}장`
            );
          } else {
            console.warn(`${i + 1}번째 사진 촬영 실패`);
          }

          if (i < TOTAL_CUTS - 1) {
            captureStatus.textContent = `촬영 중입니다... (${
              i + 1
            }/${TOTAL_CUTS} 완료)`;
            await new Promise((resolve) =>
              setTimeout(resolve, CUT_INTERVAL_MS)
            );
          }
        }

        console.log(
          `촬영 완료: 총 ${capturedCuts.length}장 (예상: ${TOTAL_CUTS}장)`
        );

        clearInterval(gifIntervalId);

        captureStatus.textContent =
          '촬영이 완료되었습니다. 이미지를 합성 중입니다.';

        goToPage(PAGES.LOADING);
        startProcessing();
      }

      // =========================
      // 프레임 이미지 로드
      // =========================
      async function loadFrameImages() {
        frameBackgroundImg = null;
        frameImages = [];
        sampleOverlayImages = [];

        // 프레임 후보 이미지 로드
        if (SAMPLE_OVERLAY_IMAGES && Array.isArray(SAMPLE_OVERLAY_IMAGES)) {
          const loadPromises = SAMPLE_OVERLAY_IMAGES.map((src, index) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.onload = () => {
                console.log(
                  `오버레이 이미지 ${index + 1} 로드 완료:`,
                  img.width,
                  img.height
                );
                resolve(img);
              };
              img.onerror = () => {
                console.warn(`오버레이 이미지 ${index + 1} 로드 실패:`, src);
                resolve(null);
              };
              img.src = src;
            });
          });
          sampleOverlayImages = await Promise.all(loadPromises);
        }

        // 전체 배경 프레임 이미지 로드
        if (FRAME_BACKGROUND_IMAGE) {
          frameBackgroundImg = await new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => {
              console.warn(
                '배경 프레임 이미지 로드 실패:',
                FRAME_BACKGROUND_IMAGE
              );
              resolve(null);
            };
            img.src = FRAME_BACKGROUND_IMAGE;
          });
        }

        // 개별 프레임 이미지 로드
        if (FRAME_IMAGES && Array.isArray(FRAME_IMAGES)) {
          const loadPromises = FRAME_IMAGES.map((src, index) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => {
                console.warn(`프레임 이미지 ${index + 1} 로드 실패:`, src);
                resolve(null);
              };
              img.src = src;
            });
          });
          frameImages = await Promise.all(loadPromises);
        }
      }

      // =========================
      // 1컷 스트립 합성
      // =========================
      function buildStripCanvas() {
        const canvas = stripCanvas;
        const ctx = canvas.getContext('2d');

        console.log(
          `스트립 합성 시작: capturedCuts.length = ${capturedCuts.length}`
        );

        if (capturedCuts.length === 0) {
          // 캡처가 하나도 없을 때 기본 사이즈만 지정
          canvas.width = 600;
          canvas.height = 450;
          ctx.fillStyle = '#9ca3af';
          ctx.font = '24px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(
            '촬영된 사진이 없습니다.',
            canvas.width / 2,
            canvas.height / 2
          );
          return;
        }

        const image = capturedCuts[0];

        // ✅ 최종 캔버스 크기를 "촬영 이미지와 동일"하게 설정
        const stripWidth = image.width;
        const stripHeight = image.height;
        canvas.width = stripWidth;
        canvas.height = stripHeight;

        // 배경 (원하면 여기에 프레임 배경 이미지를 깔아도 됨)
        if (frameBackgroundImg) {
          ctx.drawImage(frameBackgroundImg, 0, 0, stripWidth, stripHeight);
        } else {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, stripWidth, stripHeight);
        }

        // ✅ 촬영 이미지를 비율 그대로 전체에 맞춰서 그림 (늘어짐 없음)
        ctx.drawImage(image, 0, 0, stripWidth, stripHeight);

        console.log(`스트립 합성 완료: ${stripWidth}x${stripHeight}`);
        stripImageUrl = canvas.toDataURL('image/png');
      }
      // =========================
      // GIF 생성 (gif.js)
      // =========================
      function buildGif() {
        return new Promise((resolve) => {
          if (gifFrames.length === 0) {
            resolve(null);
            return;
          }

          progressText.textContent = 'GIF를 생성하고 있어요...';

          const gif = new GIF({
            workers: 2,
            quality: 10,
            workerScript: './assets/gif/gif.worker.js',
          });

          gifFrames.forEach((frameCanvas) => {
            gif.addFrame(frameCanvas, { delay: GIF_SNAPSHOT_INTERVAL_MS });
          });

          gif.on('progress', (p) => {
            const percent = Math.round(p * 100);
            progressText.textContent = `GIF 생성 중... ${percent}%`;
          });

          gif.on('finished', (blob) => {
            if (gifUrl) URL.revokeObjectURL(gifUrl);
            gifUrl = URL.createObjectURL(blob);
            resolve(gifUrl);
          });

          gif.render();
        });
      }

      // =========================
      // 로딩 페이지에서 처리 시작
      // =========================
      async function startProcessing() {
        // 1) 최종 이미지 캔버스 합성
        buildStripCanvas();

        // 2) GIF 생성
        const url = await buildGif();

        if (url) {
          loadingGifPreview.src = url;
          loadingGifPreview.classList.remove('hidden');
          progressText.textContent = '거의 다 됐어요!';
        } else {
          progressText.textContent =
            'GIF 생성에 실패했어요. 1컷 이미지만 제공됩니다.';
        }

        // 3) ✅ S3 업로드 진행
        progressText.textContent = '이미지를 업로드하고 있어요...';
        const uploadedUrl = await uploadStripToS3();
        uploadedImageUrl = uploadedUrl;

        if (uploadedUrl) {
          progressText.textContent = '업로드 완료! 결과를 확인하세요.';
        } else {
          progressText.textContent =
            '업로드에 실패했어요. QR 코드는 제공되지 않습니다.';
        }

        // 4) 결과 페이지 버튼 활성화
        goResultBtn.disabled = false;
      }

      // =========================
      // 다운로드 & 공유
      // =========================
      function downloadStrip() {
        if (!stripImageUrl) return;
        const a = document.createElement('a');
        a.href = stripImageUrl;
        a.download = 'lifesinglecut.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function downloadGif() {
        if (!gifUrl) {
          alert('GIF가 생성되지 않았어요.');
          return;
        }
        const a = document.createElement('a');
        a.href = gifUrl;
        a.download = 'lifesinglecut.gif';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      async function shareResult() {
        if (!navigator.share) {
          alert('이 브라우저는 Web Share API를 지원하지 않습니다.');
          return;
        }
        try {
          await navigator.share({
            title: '인생네컷',
            text: '내가 찍은 인생한컷!',
            url: window.location.href,
          });
        } catch (e) {
          console.log('공유 취소/오류:', e);
        }
      }

      // =========================
      // 초기화
      // =========================
      function resetAll() {
        capturedCuts = [];
        gifFrames = [];
        stripImageUrl = null;
        currentCaptureIndex = 0;
        currentFrameIndex = 0;
        if (gifUrl) {
          URL.revokeObjectURL(gifUrl);
          gifUrl = null;
        }
        captureStatus.textContent = '카메라 준비 중입니다...';
        captureStartBtn.disabled = true;

        if (capturedPreviewContainer) {
          capturedPreviewContainer.innerHTML = '';
        }

        if (overlaySampleEl && FRAME_OPTIONS.length > 0) {
          overlaySampleEl.src = FRAME_OPTIONS[0];
        }
        renderFrameSelector();
      }

      // =========================
      // 이벤트 바인딩
      // =========================
      startBtn.addEventListener('click', async () => {
        await loadFrameImages();
        goToPage(PAGES.CAPTURE);
        startCamera();
      });

      captureStartBtn.addEventListener('click', () => {
        startAutoCaptureSession();
      });

      downloadStripBtn.addEventListener('click', downloadStrip);
      downloadGifBtn.addEventListener('click', downloadGif);
      shareBtn.addEventListener('click', shareResult);

      restartBtn.addEventListener('click', () => {
        resetAll();
        goToPage(PAGES.INTRO);
      });

      window.addEventListener('beforeunload', () => {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
        }
        if (gifUrl) URL.revokeObjectURL(gifUrl);
      });

      // 첫 렌더링 시 프레임 선택 UI만 미리 렌더
      renderFrameSelector();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  </body>
</html>
