<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ì¸ìƒë„¤ì»· ì›¹ìº  ë¶€ìŠ¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CSS CDN (í•„ìš” ì—†ìœ¼ë©´ ì»¤ìŠ¤í…€ CSSë¡œ êµì²´ ê°€ëŠ¥) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- gif.js (GIF ìƒì„±ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="./assets/gif/gif.js"></script>

    <style>
      body {
        background: #f9fafb;
      }

      .page {
        display: none;
      }
      .page.active {
        display: flex;
      }

      /* ì²« í˜ì´ì§€ì—ë§Œ ë°°ê²½ ì´ë¯¸ì§€ ì ìš© */
      #page-1 {
        background-image: url('./assets/imgs/main_background.svg');
        background-size: contain;
        background-position: center center;
        background-repeat: no-repeat;
        background-attachment: scroll;
        min-height: 100vh;
        width: 100%;
        position: relative;
      }

      /* 4ì»· ìŠ¤íŠ¸ë¦½ ìº”ë²„ìŠ¤ */
      #stripCanvas {
        width: 100%;
        height: auto;
        display: block;
      }

      /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #111827;
        border-radius: 9999px;
        width: 3rem;
        height: 3rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* GIF ìº”ë²„ìŠ¤ (ìŠ¤ëƒ…ìƒ·ìš©) */
      #gifFrameCanvas {
        display: none;
      }

      /* ì•± ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
      #app {
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      /* ì´¬ì˜ í™”ë©´ ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ */
      #videoContainer {
        width: 600px;
        height: 450px; /* 600 * (180/240) = 450px */
        max-width: 100%;
      }

      /* íƒœë¸”ë¦¿, ëª¨ë°”ì¼ ì‚¬ì´ì¦ˆì—ì„œ ì¢Œìš° ë§ˆì§„ 80px */
      @media (max-width: 1024px) {
        #app {
          margin-left: 80px;
          margin-right: 80px;
        }

        #videoContainer {
          width: calc(100vw - 160px); /* ì¢Œìš° ì—¬ë°± 80pxì”© */
          height: calc((100vw - 160px) * 180 / 240); /* 240:180 ë¹„ìœ¨ ìœ ì§€ */
        }
      }

      /* ì‘ì€ ëª¨ë°”ì¼ì—ì„œë„ 80px ë§ˆì§„ ìœ ì§€ */
      @media (max-width: 480px) {
        #app {
          margin-left: 80px;
          margin-right: 80px;
        }

        #videoContainer {
          width: calc(100vw - 160px);
          height: calc((100vw - 160px) * 180 / 240);
        }
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center">
    <div id="app" class="w-full p-4">
      <!-- ====== PAGE 1 : INTRO ====== -->
      <section
        id="page-1"
        class="page active flex-col items-center justify-center text-center gap-6"
      >
        <button
          id="startBtn"
          class="mt-4 inline-flex items-center justify-center px-6 py-3 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800"
        >
          ì´¬ì˜ ì‹œì‘í•˜ê¸°
        </button>
      </section>

      <!-- ====== PAGE 2 : CAPTURE ====== -->
      <section
        id="page-2"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold mb-2">ì´¬ì˜ ì¤‘</h2>
        <p id="captureStatus" class="text-xs text-gray-500 text-center mb-2">
          ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...
        </p>

        <div
          id="videoContainer"
          class="relative bg-black rounded-2xl overflow-hidden flex items-center justify-center mx-auto"
        >
          <img
            id="overlaySample"
            src="./assets/frames/004.png"
            alt="ìƒ˜í”Œ ì˜¤ë²„ë ˆì´"
            class="absolute top-0 h-full w-auto pointer-events-none select-none opacity-90 z-20 object-contain"
          />
          <video
            id="video"
            autoplay
            playsinline
            class="relative z-10 w-full h-full object-cover"
            style="transform: scaleX(-1)"
          ></video>
        </div>
        <div
          id="capturedPreview"
          class="mt-3 w-full flex flex-row gap-2 overflow-x-auto"
        ></div>

        <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
        <div
          id="countdownOverlay"
          class="pointer-events-none fixed inset-0 flex items-center justify-center text-white text-6xl font-bold bg-black/40 opacity-0 transition-opacity z-30"
        ></div>

        <button
          id="captureStartBtn"
          class="mt-3 inline-flex items-center justify-center px-5 py-2.5 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          4ì»· ìë™ ì´¬ì˜ ì‹œì‘
        </button>

        <p class="text-[11px] text-gray-400 mt-1 text-center">
          ì´¬ì˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 3ì´ˆ ê°„ê²©ìœ¼ë¡œ 4ì¥ì„ ìë™ ì´¬ì˜í•˜ê³ ,
          <br />
          ë™ì‹œì— 0.5ì´ˆë§ˆë‹¤ GIFìš© ìŠ¤ëƒ…ìƒ·ë„ í•¨ê»˜ ì €ì¥í•©ë‹ˆë‹¤.
        </p>

        <!-- ìº¡ì²˜ìš© ìˆ¨ê¹€ ìº”ë²„ìŠ¤ -->
        <canvas id="captureCanvas" class="hidden"></canvas>
        <canvas id="gifFrameCanvas"></canvas>
      </section>

      <!-- ====== PAGE 3 : LOADING ====== -->
      <section
        id="page-3"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold">ì‚¬ì§„ì„ í•©ì„±í•˜ëŠ” ì¤‘ì´ì—ìš”</h2>
        <p class="text-xs text-gray-500 text-center">
          4ì»· ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  GIFë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”.
          <br />
          ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.
        </p>

        <div class="spinner mt-2"></div>

        <div class="mt-4 flex flex-col items-center gap-2">
          <p class="text-xs text-gray-500">GIF ë¯¸ë¦¬ë³´ê¸°</p>
          <img
            id="loadingGifPreview"
            src=""
            alt="GIF Preview"
            class="w-32 object-cover rounded-xl bg-gray-200 hidden"
            style="aspect-ratio: 240 / 180"
          />
        </div>

        <p id="progressText" class="mt-2 text-[11px] text-gray-400">
          ì¤€ë¹„ ì¤‘...
        </p>

        <button
          id="goResultBtn"
          class="mt-4 px-5 py-2.5 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          ê²°ê³¼ ë³´ëŸ¬ê°€ê¸°
        </button>
      </section>

      <!-- ====== PAGE 4 : RESULT ====== -->
      <section
        id="page-4"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold">ì™„ì„±ëœ ì¸ìƒë„¤ì»·</h2>

        <!-- 4ì»· ìŠ¤íŠ¸ë¦½ -->
        <div
          class="w-full max-w-xs bg-white rounded-2xl border border-gray-200 p-3 shadow-sm"
        >
          <canvas id="stripCanvas" class="w-full"></canvas>
        </div>

        <!-- GIF -->
        <div class="flex flex-col items-center gap-2 mt-2">
          <p class="text-xs text-gray-500">GIF ì• ë‹ˆë©”ì´ì…˜</p>
          <img
            id="resultGif"
            src=""
            alt="Result GIF"
            class="w-32 object-cover rounded-xl bg-gray-200"
            style="aspect-ratio: 240 / 180"
          />
        </div>

        <!-- ë²„íŠ¼ë“¤ -->
        <div class="mt-4 flex flex-wrap justify-center gap-2">
          <button
            id="downloadStripBtn"
            class="px-4 py-2 rounded-full bg-black text-white text-xs font-medium hover:bg-gray-800"
          >
            4ì»· ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          </button>
          <button
            id="downloadGifBtn"
            class="px-4 py-2 rounded-full bg-white border border-gray-300 text-xs font-medium hover:bg-gray-50"
          >
            GIF ë‹¤ìš´ë¡œë“œ
          </button>
          <button
            id="shareBtn"
            class="px-4 py-2 rounded-full bg-blue-500 text-white text-xs font-medium hover:bg-blue-600"
          >
            ê³µìœ í•˜ê¸°
          </button>
        </div>

        <button
          id="restartBtn"
          class="mt-4 px-4 py-2 rounded-full bg-gray-100 text-xs text-gray-600 hover:bg-gray-200"
        >
          ë‹¤ì‹œ ì°ê¸°
        </button>
      </section>
    </div>

    <script>
      // =========================
      // ê¸€ë¡œë²Œ ìƒíƒœ
      // =========================
      const PAGES = {
        INTRO: 1,
        CAPTURE: 2,
        LOADING: 3,
        RESULT: 4,
      };

      const TOTAL_CUTS = 4; // ì¸ìƒë„¤ì»· ì¥ ìˆ˜
      const CUT_INTERVAL_MS = 3000; // ê° ì»· ì‚¬ì´ ê°„ê²© (3ì´ˆ)
      const GIF_SNAPSHOT_INTERVAL_MS = 500; // GIF í”„ë ˆì„ ê°„ê²© (0.5ì´ˆ)

      // ê° ì´¬ì˜ë³„ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ (1, 2, 3, 4ë²ˆì§¸ ìˆœì„œ)
      const SAMPLE_OVERLAY_IMAGES = [
        './assets/frames/004.png', // 1ë²ˆì§¸
        './assets/frames/005.png', // 2ë²ˆì§¸
        './assets/frames/006.png', // 3ë²ˆì§¸
        './assets/frames/007.png', // 4ë²ˆì§¸
      ];

      // í”„ë ˆì„ ì´ë¯¸ì§€ ì„¤ì •
      // ì˜µì…˜ 1: ì „ì²´ ë°°ê²½ í”„ë ˆì„ ì´ë¯¸ì§€ (600 x 1800px PNG, íˆ¬ëª…ë„ ì§€ì›)
      // ì˜µì…˜ 2: ê°œë³„ í”„ë ˆì„ ì´ë¯¸ì§€ ë°°ì—´ (ê° 480 x 380px PNG)
      // ì˜µì…˜ 3: null (ê¸°ë³¸ í”„ë ˆì„ ì‚¬ìš©)
      // ì˜µì…˜ 1: ì „ì²´ ë°°ê²½ í”„ë ˆì„ ì‚¬ìš©
      const FRAME_BACKGROUND_IMAGE = './assets/frames/full-frame.png';
      const FRAME_IMAGES = null; // ì˜ˆ: ['./assets/frames/frame1.png', './assets/frames/frame2.png', ...]
      // ë˜ëŠ” ëª¨ë“  í”„ë ˆì„ì— ê°™ì€ ì´ë¯¸ì§€ ì‚¬ìš©: ['./assets/frames/single-frame.png', ...] (4ê°œ)

      let currentPage = PAGES.INTRO;
      let stream = null;
      let capturedCuts = []; // [{image: Image}]
      let gifFrames = []; // [HTMLCanvasElement]
      let gifUrl = null; // object URL
      let stripImageUrl = null;
      let frameBackgroundImg = null; // ë¡œë“œëœ ë°°ê²½ í”„ë ˆì„ ì´ë¯¸ì§€
      let frameImages = []; // ë¡œë“œëœ ê°œë³„ í”„ë ˆì„ ì´ë¯¸ì§€ ë°°ì—´
      let sampleOverlayImages = []; // ê° ì´¬ì˜ë³„ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ë°°ì—´
      let currentCaptureIndex = 0; // í˜„ì¬ ì´¬ì˜ ì¸ë±ìŠ¤ (0~3)

      // DOM
      const pageElements = {
        1: document.getElementById('page-1'),
        2: document.getElementById('page-2'),
        3: document.getElementById('page-3'),
        4: document.getElementById('page-4'),
      };

      const startBtn = document.getElementById('startBtn');
      const captureStartBtn = document.getElementById('captureStartBtn');
      const restartBtn = document.getElementById('restartBtn');

      const video = document.getElementById('video');
      const captureCanvas = document.getElementById('captureCanvas');
      const gifFrameCanvas = document.getElementById('gifFrameCanvas');

      const countdownOverlay = document.getElementById('countdownOverlay');
      const captureStatus = document.getElementById('captureStatus');

      const stripCanvas = document.getElementById('stripCanvas');
      const loadingGifPreview = document.getElementById('loadingGifPreview');
      const progressText = document.getElementById('progressText');
      const goResultBtn = document.getElementById('goResultBtn');

      const resultGif = document.getElementById('resultGif');
      const downloadStripBtn = document.getElementById('downloadStripBtn');
      const downloadGifBtn = document.getElementById('downloadGifBtn');
      const shareBtn = document.getElementById('shareBtn');

      const capturedPreviewContainer =
        document.getElementById('capturedPreview');

      function addCapturedPreview(image) {
        if (!capturedPreviewContainer || !image) return;

        // ì¸ë„¤ì¼ ì¹´ë“œ ë˜í¼ (240:180 ë¹„ìœ¨)
        const wrapper = document.createElement('div');
        wrapper.className =
          'w-20 flex-shrink-0 overflow-hidden rounded-md border border-gray-300 bg-white shadow-sm';
        wrapper.style.aspectRatio = '240 / 180';

        // ì‹¤ì œ ì´ë¯¸ì§€
        const thumb = document.createElement('img');
        thumb.src = image.src; // captureStillFrameì—ì„œ ë§Œë“  Image ê°ì²´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        thumb.className = 'w-full h-full object-cover';

        wrapper.appendChild(thumb);
        capturedPreviewContainer.appendChild(wrapper);
      }

      const overlaySampleEl = document.getElementById('overlaySample');
      // =========================
      // í˜ì´ì§€ ì „í™˜
      // =========================
      function goToPage(pageNumber) {
        currentPage = pageNumber;
        Object.entries(pageElements).forEach(([page, el]) => {
          if (Number(page) === pageNumber) el.classList.add('active');
          else el.classList.remove('active');
        });
      }

      // =========================
      // ì¹´ë©”ë¼ ì‹œì‘
      // =========================
      async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì›¹ìº ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          captureStatus.textContent = 'ì›¹ìº ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.';
          return;
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' },
            audio: false,
          });
          video.srcObject = stream;
          captureStatus.textContent =
            'ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ! ì´¬ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
          captureStartBtn.disabled = false;

          // ì²« ë²ˆì§¸ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ í‘œì‹œ
          currentCaptureIndex = 0;
          if (overlaySampleEl && SAMPLE_OVERLAY_IMAGES.length > 0) {
            overlaySampleEl.src = SAMPLE_OVERLAY_IMAGES[0];
          }
        } catch (err) {
          console.error(err);
          alert('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
          captureStatus.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
      }

      // =========================
      // ë‹¨ì¼ í”„ë ˆì„ ìº¡ì²˜ (ì •ì§€ì»·)
      // =========================
      function captureStillFrame(captureIndex = currentCaptureIndex) {
        if (!video.videoWidth || !video.videoHeight) {
          console.warn('ë¹„ë””ì˜¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return null;
        }

        const w = video.videoWidth;
        const h = video.videoHeight;

        captureCanvas.width = w;
        captureCanvas.height = h;

        const ctx = captureCanvas.getContext('2d');

        // 1) ë¹„ë””ì˜¤ (ì¢Œìš° ë°˜ì „)
        ctx.save();
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, w, h);
        ctx.restore();

        // 2) í”„ë ˆì„ ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ (í˜„ì¬ ì´¬ì˜ ì¸ë±ìŠ¤ì— ë§ëŠ” ì´ë¯¸ì§€ ì‚¬ìš©)
        const overlayImg = sampleOverlayImages[captureIndex];
        if (overlayImg) {
          ctx.drawImage(overlayImg, 0, 0, w, h);
        }

        // 3) ìº”ë²„ìŠ¤ë¥¼ Imageë¡œ ë³€í™˜
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = w;
        frameCanvas.height = h;
        frameCanvas.getContext('2d').drawImage(captureCanvas, 0, 0);

        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => {
            console.warn('ìº¡ì²˜ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
            resolve(null);
          };
          img.src = frameCanvas.toDataURL('image/png');
        });
      }
      // =========================
      // GIF í”„ë ˆì„ ìº¡ì²˜
      // =========================
      function captureGifFrame() {
        if (!video.videoWidth || !video.videoHeight) return;

        // ì •ì§€ì»·ê³¼ ë™ì¼í•œ í•´ìƒë„ ì‚¬ìš©
        const w = video.videoWidth;
        const h = video.videoHeight;

        gifFrameCanvas.width = w;
        gifFrameCanvas.height = h;

        const ctx = gifFrameCanvas.getContext('2d');

        // 1) ë¹„ë””ì˜¤ (ì¢Œìš° ë°˜ì „)
        ctx.save();
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, w, h);
        ctx.restore();

        // 2) í”„ë ˆì„ ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ (í˜„ì¬ ì´¬ì˜ ì¸ë±ìŠ¤ì— ë§ëŠ” ì´ë¯¸ì§€ ì‚¬ìš©)
        const overlayImg = sampleOverlayImages[currentCaptureIndex];
        if (overlayImg) {
          ctx.drawImage(overlayImg, 0, 0, w, h);
        }

        // 3) ì´ ìº”ë²„ìŠ¤ë¥¼ í”„ë ˆì„ìœ¼ë¡œ ì‚¬ìš©
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = w;
        frameCanvas.height = h;
        frameCanvas.getContext('2d').drawImage(gifFrameCanvas, 0, 0);
        gifFrames.push(frameCanvas);
      }

      // =========================
      // ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
      // =========================
      function showCountdown(seconds) {
        return new Promise((resolve) => {
          let n = seconds;
          countdownOverlay.textContent = n;
          countdownOverlay.style.opacity = '1';

          const tick = () => {
            setTimeout(() => {
              n--;
              if (n <= 0) {
                countdownOverlay.style.opacity = '0';
                countdownOverlay.textContent = '';
                resolve();
              } else {
                countdownOverlay.textContent = n;
                tick();
              }
            }, 1000);
          };
          tick();
        });
      }

      // =========================
      // 4ì»· ìë™ ì´¬ì˜
      // =========================
      async function startAutoCaptureSession() {
        captureStartBtn.disabled = true;
        capturedCuts = [];
        gifFrames = [];

        captureStatus.textContent =
          'ì´¬ì˜ ì¤‘ì…ë‹ˆë‹¤. ì›€ì§ì´ë©´ì„œ í¬ì¦ˆë¥¼ ë°”ê¿”ë³´ì„¸ìš”!';

        // GIF í”„ë ˆì„ ìº¡ì²˜ íƒ€ì´ë¨¸ ì‹œì‘
        const gifIntervalId = setInterval(
          captureGifFrame,
          GIF_SNAPSHOT_INTERVAL_MS
        );

        // 4ì»· ì´¬ì˜ (ê° ì»· ì´¬ì˜ ì „ ì¹´ìš´íŠ¸ë‹¤ìš´)
        for (let i = 0; i < TOTAL_CUTS; i++) {
          // í˜„ì¬ ì´¬ì˜ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
          currentCaptureIndex = i;

          // í™”ë©´ì˜ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          const overlayImg = sampleOverlayImages[i];
          if (overlayImg && overlaySampleEl) {
            overlaySampleEl.src = SAMPLE_OVERLAY_IMAGES[i];
          }

          // ê° ì»· ì´¬ì˜ ì „ 3ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
          captureStatus.textContent = `${i + 1}ë²ˆì§¸ ì‚¬ì§„ ì´¬ì˜ ì¤€ë¹„...`;
          await showCountdown(3);

          // ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì¦‰ì‹œ ì´¬ì˜ (ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°)
          const img = await captureStillFrame(i);
          if (img) {
            capturedCuts.push(img);
            addCapturedPreview(img); // ğŸ”¹ ì—¬ê¸° ì¶”ê°€
            console.log(
              `${i + 1}ë²ˆì§¸ ì‚¬ì§„ ì´¬ì˜ ì™„ë£Œ. ì´ ${capturedCuts.length}ì¥`
            );
          } else {
            console.warn(`${i + 1}ë²ˆì§¸ ì‚¬ì§„ ì´¬ì˜ ì‹¤íŒ¨`);
          }

          // ë§ˆì§€ë§‰ ì»·ì´ ì•„ë‹ˆë©´ ë‹¤ìŒ ì´¬ì˜ì„ ìœ„í•´ ëŒ€ê¸°
          if (i < TOTAL_CUTS - 1) {
            captureStatus.textContent = `ì´¬ì˜ ì¤‘ì…ë‹ˆë‹¤... (${
              i + 1
            }/${TOTAL_CUTS} ì™„ë£Œ)`;
            await new Promise((resolve) =>
              setTimeout(resolve, CUT_INTERVAL_MS)
            );
          }
        }

        console.log(
          `ì´¬ì˜ ì™„ë£Œ: ì´ ${capturedCuts.length}ì¥ (ì˜ˆìƒ: ${TOTAL_CUTS}ì¥)`
        );

        // GIF ìº¡ì²˜ ì¤‘ì§€
        clearInterval(gifIntervalId);

        captureStatus.textContent =
          'ì´¬ì˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ í•©ì„± ì¤‘ì…ë‹ˆë‹¤.';

        // í˜ì´ì§€ 3ìœ¼ë¡œ ì´ë™ + ì²˜ë¦¬ ì‹œì‘
        goToPage(PAGES.LOADING);
        startProcessing();
      }

      // =========================
      // í”„ë ˆì„ ì´ë¯¸ì§€ ë¡œë“œ
      // =========================
      async function loadFrameImages() {
        frameBackgroundImg = null;
        frameImages = [];
        sampleOverlayImages = [];

        // ê° ì´¬ì˜ë³„ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ë¡œë“œ
        if (SAMPLE_OVERLAY_IMAGES && Array.isArray(SAMPLE_OVERLAY_IMAGES)) {
          const loadPromises = SAMPLE_OVERLAY_IMAGES.map((src, index) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.onload = () => {
                console.log(
                  `ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ${index + 1} ë¡œë“œ ì™„ë£Œ:`,
                  img.width,
                  img.height
                );
                resolve(img);
              };
              img.onerror = () => {
                console.warn(`ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ${index + 1} ë¡œë“œ ì‹¤íŒ¨:`, src);
                resolve(null);
              };
              img.src = src;
            });
          });
          sampleOverlayImages = await Promise.all(loadPromises);
        }

        // ì „ì²´ ë°°ê²½ í”„ë ˆì„ ì´ë¯¸ì§€ ë¡œë“œ
        if (FRAME_BACKGROUND_IMAGE) {
          frameBackgroundImg = await new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => {
              console.warn(
                'ë°°ê²½ í”„ë ˆì„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:',
                FRAME_BACKGROUND_IMAGE
              );
              resolve(null);
            };
            img.src = FRAME_BACKGROUND_IMAGE;
          });
        }

        // ê°œë³„ í”„ë ˆì„ ì´ë¯¸ì§€ ë¡œë“œ
        if (FRAME_IMAGES && Array.isArray(FRAME_IMAGES)) {
          const loadPromises = FRAME_IMAGES.map((src, index) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => {
                console.warn(`í”„ë ˆì„ ì´ë¯¸ì§€ ${index + 1} ë¡œë“œ ì‹¤íŒ¨:`, src);
                resolve(null);
              };
              img.src = src;
            });
          });
          frameImages = await Promise.all(loadPromises);
        }
      }

      // =========================
      // 4ì»· ìŠ¤íŠ¸ë¦½ í•©ì„±
      // =========================
      function buildStripCanvas() {
        const canvas = stripCanvas;
        const ctx = canvas.getContext('2d');

        const stripWidth = 600;
        const stripHeight = 1800; // 1:3 ë¹„ìœ¨
        canvas.width = stripWidth;
        canvas.height = stripHeight;

        // ë°°ê²½: í”„ë ˆì„ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ í°ìƒ‰
        if (frameBackgroundImg) {
          ctx.drawImage(frameBackgroundImg, 0, 0, stripWidth, stripHeight);
        } else {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, stripWidth, stripHeight);
        }

        console.log(
          `ìŠ¤íŠ¸ë¦½ í•©ì„± ì‹œì‘: capturedCuts.length = ${capturedCuts.length}`
        );

        if (capturedCuts.length === 0) {
          ctx.fillStyle = '#9ca3af';
          ctx.font = '24px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(
            'ì´¬ì˜ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.',
            stripWidth / 2,
            stripHeight / 2
          );
          return;
        }

        const marginTop = 80;
        const marginBottom = 80;
        const verticalGap = 40;
        const availableHeight =
          stripHeight -
          marginTop -
          marginBottom -
          verticalGap * (TOTAL_CUTS - 1);
        const frameHeight = availableHeight / TOTAL_CUTS;
        const frameWidth = stripWidth * 0.8;
        const left = (stripWidth - frameWidth) / 2;

        for (let i = 0; i < TOTAL_CUTS; i++) {
          const top = marginTop + i * (frameHeight + verticalGap);

          // ê°œë³„ í”„ë ˆì„ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ í…Œë‘ë¦¬
          const frameImg =
            frameImages[i] || (frameImages.length > 0 ? frameImages[0] : null);

          if (frameImg) {
            // í”„ë ˆì„ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            ctx.drawImage(frameImg, left, top, frameWidth, frameHeight);
          } else {
            // ê¸°ë³¸ í”„ë ˆì„ í…Œë‘ë¦¬
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 8;
            ctx.strokeRect(left, top, frameWidth, frameHeight);
          }

          if (i < capturedCuts.length) {
            const image = capturedCuts[i];
            console.log(
              `í”„ë ˆì„ ${i + 1} ê·¸ë¦¬ê¸°: image.width=${
                image.width
              }, image.height=${image.height}`
            );

            if (image.width > 0 && image.height > 0) {
              const imageRatio = image.width / image.height;
              const frameRatio = frameWidth / frameHeight;

              let drawWidth, drawHeight;
              if (imageRatio > frameRatio) {
                drawWidth = frameWidth;
                drawHeight = frameWidth / imageRatio;
              } else {
                drawHeight = frameHeight;
                drawWidth = frameHeight * imageRatio;
              }

              const dx = left + (frameWidth - drawWidth) / 2;
              const dy = top + (frameHeight - drawHeight) / 2;

              ctx.save();
              ctx.beginPath();
              ctx.rect(left, top, frameWidth, frameHeight);
              ctx.clip();
              ctx.drawImage(image, dx, dy, drawWidth, drawHeight);
              ctx.restore();
            } else {
              console.warn(`í”„ë ˆì„ ${i + 1} ì´ë¯¸ì§€ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤.`);
            }
          } else {
            console.warn(`í”„ë ˆì„ ${i + 1}ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.`);
          }
        }

        function captureGifFrame() {
          if (!video.videoWidth || !video.videoHeight) return;
          const targetWidth = 320;
          const ratio = video.videoHeight / video.videoWidth;
          const targetHeight = targetWidth * ratio;

          gifFrameCanvas.width = targetWidth;
          gifFrameCanvas.height = targetHeight;

          const ctx = gifFrameCanvas.getContext('2d');

          // ë¹„ë””ì˜¤ (ì¢Œìš° ë°˜ì „)
          ctx.save();
          ctx.translate(targetWidth, 0);
          ctx.scale(-1, 1);
          ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
          ctx.restore();

          // ìº”ë²„ìŠ¤ë¥¼ í”„ë ˆì„ìœ¼ë¡œ ì €ì¥
          const frameCanvas = document.createElement('canvas');
          frameCanvas.width = gifFrameCanvas.width;
          frameCanvas.height = gifFrameCanvas.height;
          frameCanvas.getContext('2d').drawImage(gifFrameCanvas, 0, 0);
          gifFrames.push(frameCanvas);
        }

        console.log(`ìŠ¤íŠ¸ë¦½ í•©ì„± ì™„ë£Œ: ì´ ${capturedCuts.length}ì¥ ì‚¬ìš©`);
        stripImageUrl = canvas.toDataURL('image/png');
      }

      // =========================
      // GIF ìƒì„± (gif.js)
      // =========================
      function buildGif() {
        return new Promise((resolve) => {
          if (gifFrames.length === 0) {
            resolve(null);
            return;
          }

          progressText.textContent = 'GIFë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”...';

          const gif = new GIF({
            workers: 2,
            quality: 10,
            workerScript: './assets/gif/gif.worker.js',
          });

          gifFrames.forEach((frameCanvas) => {
            gif.addFrame(frameCanvas, { delay: GIF_SNAPSHOT_INTERVAL_MS });
          });

          gif.on('progress', (p) => {
            const percent = Math.round(p * 100);
            progressText.textContent = `GIF ìƒì„± ì¤‘... ${percent}%`;
          });

          gif.on('finished', (blob) => {
            if (gifUrl) URL.revokeObjectURL(gifUrl);
            gifUrl = URL.createObjectURL(blob);
            resolve(gifUrl);
          });

          gif.render();
        });
      }

      // =========================
      // ë¡œë”© í˜ì´ì§€ì—ì„œ ì²˜ë¦¬ ì‹œì‘
      // =========================
      async function startProcessing() {
        // 4ì»· ìŠ¤íŠ¸ë¦½ ë¨¼ì € í•©ì„±
        buildStripCanvas();

        // GIF ìƒì„±
        const url = await buildGif();

        if (url) {
          loadingGifPreview.src = url;
          loadingGifPreview.classList.remove('hidden');
          progressText.textContent = 'ê±°ì˜ ë‹¤ ëì–´ìš”!';
        } else {
          progressText.textContent =
            'GIF ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. 4ì»· ì´ë¯¸ì§€ë§Œ ì œê³µë©ë‹ˆë‹¤.';
        }

        goResultBtn.disabled = false;
      }

      // =========================
      // ë‹¤ìš´ë¡œë“œ & ê³µìœ 
      // =========================
      function downloadStrip() {
        if (!stripImageUrl) return;
        const a = document.createElement('a');
        a.href = stripImageUrl;
        a.download = 'lifefourcut.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function downloadGif() {
        if (!gifUrl) {
          alert('GIFê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ì–´ìš”.');
          return;
        }
        const a = document.createElement('a');
        a.href = gifUrl;
        a.download = 'lifefourcut.gif';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      async function shareResult() {
        if (!navigator.share) {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Share APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        try {
          await navigator.share({
            title: 'ì¸ìƒë„¤ì»·',
            text: 'ë‚´ê°€ ì°ì€ ì¸ìƒë„¤ì»·!',
            url: window.location.href, // í•„ìš”ì— ë”°ë¼ ìˆ˜ì •
          });
        } catch (e) {
          console.log('ê³µìœ  ì·¨ì†Œ/ì˜¤ë¥˜:', e);
        }
      }

      // =========================
      // ì´ˆê¸°í™”
      // =========================
      function resetAll() {
        capturedCuts = [];
        gifFrames = [];
        stripImageUrl = null;
        currentCaptureIndex = 0;
        if (gifUrl) {
          URL.revokeObjectURL(gifUrl);
          gifUrl = null;
        }
        captureStatus.textContent = 'ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...';
        captureStartBtn.disabled = true;

        if (capturedPreviewContainer) {
          capturedPreviewContainer.innerHTML = '';
        }

        // ì²« ë²ˆì§¸ ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ë¡œ ì´ˆê¸°í™”
        if (overlaySampleEl && SAMPLE_OVERLAY_IMAGES.length > 0) {
          overlaySampleEl.src = SAMPLE_OVERLAY_IMAGES[0];
        }
      }

      // =========================
      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      // =========================
      startBtn.addEventListener('click', async () => {
        // 1. í”„ë ˆì„/ì˜¤ë²„ë ˆì´ ì´ë¯¸ì§€ ë¨¼ì € ë¡œë“œ
        await loadFrameImages();

        // 2. ì´¬ì˜ í˜ì´ì§€ë¡œ ì´ë™
        goToPage(PAGES.CAPTURE);

        // 3. ì¹´ë©”ë¼ ì‹œì‘
        startCamera();
      });

      captureStartBtn.addEventListener('click', () => {
        startAutoCaptureSession();
      });

      goResultBtn.addEventListener('click', () => {
        // ê²°ê³¼ í˜ì´ì§€ ì„¸íŒ…
        if (gifUrl) {
          resultGif.src = gifUrl;
        }
        goToPage(PAGES.RESULT);
      });

      downloadStripBtn.addEventListener('click', downloadStrip);
      downloadGifBtn.addEventListener('click', downloadGif);
      shareBtn.addEventListener('click', shareResult);

      restartBtn.addEventListener('click', () => {
        resetAll();
        goToPage(PAGES.INTRO);
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ
      window.addEventListener('beforeunload', () => {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
        }
        if (gifUrl) URL.revokeObjectURL(gifUrl);
      });
    </script>
  </body>
</html>
