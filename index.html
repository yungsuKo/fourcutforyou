<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>인생네컷 웹캠 부스</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CSS CDN (필요 없으면 커스텀 CSS로 교체 가능) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- gif.js (GIF 생성용 라이브러리) -->
    <script src="./assets/gif/gif.js"></script>

    <style>
      body {
        background: #f9fafb;
      }

      .page {
        display: none;
      }
      .page.active {
        display: flex;
      }

      /* 4컷 스트립 캔버스 */
      #stripCanvas {
        width: 100%;
        height: auto;
        display: block;
      }

      /* 로딩 스피너 */
      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #111827;
        border-radius: 9999px;
        width: 3rem;
        height: 3rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* GIF 캔버스 (스냅샷용) */
      #gifFrameCanvas {
        display: none;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center">
    <div id="app" class="w-full max-w-xl mx-auto p-4">
      <!-- ====== PAGE 1 : INTRO ====== -->
      <section
        id="page-1"
        class="page active flex-col items-center justify-center text-center gap-6"
      >
        <h1 class="text-2xl font-bold">인생네컷 부스</h1>
        <p class="text-gray-600 text-sm leading-relaxed">
          웹캠으로 4컷 사진을 찍고,
          <br />
          촬영 중에는 0.5초 단위로 스냅샷을 모아서 GIF도 만들어 드릴게요.
        </p>
        <ul class="text-xs text-gray-500 space-y-1">
          <li>· 4장의 사진을 3초 간격으로 자동 촬영</li>
          <li>· 촬영 전체 구간에서 0.5초 간격으로 GIF 프레임 저장</li>
          <li>· 마지막에 4컷 이미지 + GIF를 다운로드/공유할 수 있어요</li>
        </ul>
        <button
          id="startBtn"
          class="mt-4 inline-flex items-center justify-center px-6 py-3 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800"
        >
          촬영 시작하기
        </button>
      </section>

      <!-- ====== PAGE 2 : CAPTURE ====== -->
      <section
        id="page-2"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold mb-2">촬영 중</h2>
        <p id="captureStatus" class="text-xs text-gray-500 text-center mb-2">
          카메라 준비 중입니다...
        </p>

        <div
          class="w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden flex items-center justify-center"
        >
          <video
            id="video"
            autoplay
            playsinline
            class="w-full h-full object-cover"
            style="transform: scaleX(-1)"
          ></video>
        </div>

        <!-- 카운트다운 오버레이 -->
        <div
          id="countdownOverlay"
          class="pointer-events-none fixed inset-0 flex items-center justify-center text-white text-6xl font-bold bg-black/40 opacity-0 transition-opacity"
        ></div>

        <button
          id="captureStartBtn"
          class="mt-3 inline-flex items-center justify-center px-5 py-2.5 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          4컷 자동 촬영 시작
        </button>

        <p class="text-[11px] text-gray-400 mt-1 text-center">
          촬영 버튼을 누르면 3초 간격으로 4장을 자동 촬영하고,
          <br />
          동시에 0.5초마다 GIF용 스냅샷도 함께 저장합니다.
        </p>

        <!-- 캡처용 숨김 캔버스 -->
        <canvas id="captureCanvas" class="hidden"></canvas>
        <canvas id="gifFrameCanvas"></canvas>
      </section>

      <!-- ====== PAGE 3 : LOADING ====== -->
      <section
        id="page-3"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold">사진을 합성하는 중이에요</h2>
        <p class="text-xs text-gray-500 text-center">
          4컷 이미지를 만들고 GIF를 생성하고 있어요.
          <br />
          조금만 기다려 주세요.
        </p>

        <div class="spinner mt-2"></div>

        <div class="mt-4 flex flex-col items-center gap-2">
          <p class="text-xs text-gray-500">GIF 미리보기</p>
          <img
            id="loadingGifPreview"
            src=""
            alt="GIF Preview"
            class="w-32 h-32 object-cover rounded-xl bg-gray-200 hidden"
          />
        </div>

        <p id="progressText" class="mt-2 text-[11px] text-gray-400">
          준비 중...
        </p>

        <button
          id="goResultBtn"
          class="mt-4 px-5 py-2.5 rounded-full bg-black text-white text-sm font-medium hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          결과 보러가기
        </button>
      </section>

      <!-- ====== PAGE 4 : RESULT ====== -->
      <section
        id="page-4"
        class="page flex-col items-center justify-center gap-4"
      >
        <h2 class="text-lg font-semibold">완성된 인생네컷</h2>

        <!-- 4컷 스트립 -->
        <div
          class="w-full max-w-xs bg-white rounded-2xl border border-gray-200 p-3 shadow-sm"
        >
          <canvas id="stripCanvas" class="w-full"></canvas>
        </div>

        <!-- GIF -->
        <div class="flex flex-col items-center gap-2 mt-2">
          <p class="text-xs text-gray-500">GIF 애니메이션</p>
          <img
            id="resultGif"
            src=""
            alt="Result GIF"
            class="w-32 h-32 object-cover rounded-xl bg-gray-200"
          />
        </div>

        <!-- 버튼들 -->
        <div class="mt-4 flex flex-wrap justify-center gap-2">
          <button
            id="downloadStripBtn"
            class="px-4 py-2 rounded-full bg-black text-white text-xs font-medium hover:bg-gray-800"
          >
            4컷 이미지 다운로드
          </button>
          <button
            id="downloadGifBtn"
            class="px-4 py-2 rounded-full bg-white border border-gray-300 text-xs font-medium hover:bg-gray-50"
          >
            GIF 다운로드
          </button>
          <button
            id="shareBtn"
            class="px-4 py-2 rounded-full bg-blue-500 text-white text-xs font-medium hover:bg-blue-600"
          >
            공유하기
          </button>
        </div>

        <button
          id="restartBtn"
          class="mt-4 px-4 py-2 rounded-full bg-gray-100 text-xs text-gray-600 hover:bg-gray-200"
        >
          다시 찍기
        </button>
      </section>
    </div>

    <script>
      // =========================
      // 글로벌 상태
      // =========================
      const PAGES = {
        INTRO: 1,
        CAPTURE: 2,
        LOADING: 3,
        RESULT: 4,
      };

      const TOTAL_CUTS = 4; // 인생네컷 장 수
      const CUT_INTERVAL_MS = 3000; // 각 컷 사이 간격 (3초)
      const GIF_SNAPSHOT_INTERVAL_MS = 500; // GIF 프레임 간격 (0.5초)

      // 프레임 이미지 설정
      // 옵션 1: 전체 배경 프레임 이미지 (600 x 1800px PNG, 투명도 지원)
      // 옵션 2: 개별 프레임 이미지 배열 (각 480 x 380px PNG)
      // 옵션 3: null (기본 프레임 사용)
      // 옵션 1: 전체 배경 프레임 사용
      const FRAME_BACKGROUND_IMAGE = './assets/frames/full-frame.png';
      const FRAME_IMAGES = null; // 예: ['./assets/frames/frame1.png', './assets/frames/frame2.png', ...]
      // 또는 모든 프레임에 같은 이미지 사용: ['./assets/frames/single-frame.png', ...] (4개)

      let currentPage = PAGES.INTRO;
      let stream = null;
      let capturedCuts = []; // [{image: Image}]
      let gifFrames = []; // [HTMLCanvasElement]
      let gifUrl = null; // object URL
      let stripImageUrl = null;
      let frameBackgroundImg = null; // 로드된 배경 프레임 이미지
      let frameImages = []; // 로드된 개별 프레임 이미지 배열

      // DOM
      const pageElements = {
        1: document.getElementById('page-1'),
        2: document.getElementById('page-2'),
        3: document.getElementById('page-3'),
        4: document.getElementById('page-4'),
      };

      const startBtn = document.getElementById('startBtn');
      const captureStartBtn = document.getElementById('captureStartBtn');
      const restartBtn = document.getElementById('restartBtn');

      const video = document.getElementById('video');
      const captureCanvas = document.getElementById('captureCanvas');
      const gifFrameCanvas = document.getElementById('gifFrameCanvas');

      const countdownOverlay = document.getElementById('countdownOverlay');
      const captureStatus = document.getElementById('captureStatus');

      const stripCanvas = document.getElementById('stripCanvas');
      const loadingGifPreview = document.getElementById('loadingGifPreview');
      const progressText = document.getElementById('progressText');
      const goResultBtn = document.getElementById('goResultBtn');

      const resultGif = document.getElementById('resultGif');
      const downloadStripBtn = document.getElementById('downloadStripBtn');
      const downloadGifBtn = document.getElementById('downloadGifBtn');
      const shareBtn = document.getElementById('shareBtn');

      // =========================
      // 페이지 전환
      // =========================
      function goToPage(pageNumber) {
        currentPage = pageNumber;
        Object.entries(pageElements).forEach(([page, el]) => {
          if (Number(page) === pageNumber) el.classList.add('active');
          else el.classList.remove('active');
        });
      }

      // =========================
      // 카메라 시작
      // =========================
      async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('이 브라우저에서는 웹캠을 사용할 수 없습니다.');
          captureStatus.textContent = '웹캠을 사용할 수 없는 환경입니다.';
          return;
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' },
            audio: false,
          });
          video.srcObject = stream;
          captureStatus.textContent =
            '카메라 준비 완료! 촬영 버튼을 눌러주세요.';
          captureStartBtn.disabled = false;
        } catch (err) {
          console.error(err);
          alert('카메라 권한을 허용해 주세요.');
          captureStatus.textContent = '카메라 권한이 필요합니다.';
        }
      }

      // =========================
      // 단일 프레임 캡처 (정지컷)
      // =========================
      function captureStillFrame() {
        if (!video.videoWidth || !video.videoHeight) return null;

        const w = video.videoWidth;
        const h = video.videoHeight;
        captureCanvas.width = w;
        captureCanvas.height = h;
        const ctx = captureCanvas.getContext('2d');

        // 좌우 반전 적용
        ctx.save();
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, w, h);
        ctx.restore();

        // 캔버스를 복사해서 저장 (이미지 로드 대기 없이 바로 사용 가능)
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = w;
        frameCanvas.height = h;
        frameCanvas.getContext('2d').drawImage(captureCanvas, 0, 0);

        // Image 객체로 변환 (로드 완료 대기)
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => resolve(null);
          img.src = frameCanvas.toDataURL('image/png');
        });
      }

      // =========================
      // GIF 프레임 캡처
      // =========================
      function captureGifFrame() {
        if (!video.videoWidth || !video.videoHeight) return;
        const targetWidth = 320;
        const ratio = video.videoHeight / video.videoWidth;
        const targetHeight = targetWidth * ratio;

        gifFrameCanvas.width = targetWidth;
        gifFrameCanvas.height = targetHeight;

        const ctx = gifFrameCanvas.getContext('2d');

        // 좌우 반전 적용
        ctx.save();
        ctx.translate(targetWidth, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
        ctx.restore();

        // 캔버스를 그대로 프레임으로 사용 (gif.js가 canvas를 받음)
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = gifFrameCanvas.width;
        frameCanvas.height = gifFrameCanvas.height;
        frameCanvas.getContext('2d').drawImage(gifFrameCanvas, 0, 0);
        gifFrames.push(frameCanvas);
      }

      // =========================
      // 카운트다운 표시
      // =========================
      function showCountdown(seconds) {
        return new Promise((resolve) => {
          let n = seconds;
          countdownOverlay.textContent = n;
          countdownOverlay.style.opacity = '1';

          const tick = () => {
            setTimeout(() => {
              n--;
              if (n <= 0) {
                countdownOverlay.style.opacity = '0';
                countdownOverlay.textContent = '';
                resolve();
              } else {
                countdownOverlay.textContent = n;
                tick();
              }
            }, 1000);
          };
          tick();
        });
      }

      // =========================
      // 4컷 자동 촬영
      // =========================
      async function startAutoCaptureSession() {
        captureStartBtn.disabled = true;
        capturedCuts = [];
        gifFrames = [];

        captureStatus.textContent =
          '촬영 중입니다. 움직이면서 포즈를 바꿔보세요!';

        // GIF 프레임 캡처 타이머 시작
        const gifIntervalId = setInterval(
          captureGifFrame,
          GIF_SNAPSHOT_INTERVAL_MS
        );

        // 4컷 촬영 (각 컷 촬영 전 카운트다운)
        for (let i = 0; i < TOTAL_CUTS; i++) {
          // 각 컷 촬영 전 3초 카운트다운
          captureStatus.textContent = `${i + 1}번째 사진 촬영 준비...`;
          await showCountdown(3);

          // 카운트다운 후 즉시 촬영 (이미지 로드 완료 대기)
          const img = await captureStillFrame();
          if (img) {
            capturedCuts.push(img);
            console.log(
              `${i + 1}번째 사진 촬영 완료. 총 ${capturedCuts.length}장`
            );
          } else {
            console.warn(`${i + 1}번째 사진 촬영 실패`);
          }

          // 마지막 컷이 아니면 다음 촬영을 위해 대기
          if (i < TOTAL_CUTS - 1) {
            captureStatus.textContent = `촬영 중입니다... (${
              i + 1
            }/${TOTAL_CUTS} 완료)`;
            await new Promise((resolve) =>
              setTimeout(resolve, CUT_INTERVAL_MS)
            );
          }
        }

        console.log(
          `촬영 완료: 총 ${capturedCuts.length}장 (예상: ${TOTAL_CUTS}장)`
        );

        // GIF 캡처 중지
        clearInterval(gifIntervalId);

        captureStatus.textContent =
          '촬영이 완료되었습니다. 이미지를 합성 중입니다.';

        // 페이지 3으로 이동 + 처리 시작
        goToPage(PAGES.LOADING);
        startProcessing();
      }

      // =========================
      // 프레임 이미지 로드
      // =========================
      async function loadFrameImages() {
        frameBackgroundImg = null;
        frameImages = [];

        // 전체 배경 프레임 이미지 로드
        if (FRAME_BACKGROUND_IMAGE) {
          frameBackgroundImg = await new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => {
              console.warn(
                '배경 프레임 이미지 로드 실패:',
                FRAME_BACKGROUND_IMAGE
              );
              resolve(null);
            };
            img.src = FRAME_BACKGROUND_IMAGE;
          });
        }

        // 개별 프레임 이미지 로드
        if (FRAME_IMAGES && Array.isArray(FRAME_IMAGES)) {
          const loadPromises = FRAME_IMAGES.map((src, index) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => {
                console.warn(`프레임 이미지 ${index + 1} 로드 실패:`, src);
                resolve(null);
              };
              img.src = src;
            });
          });
          frameImages = await Promise.all(loadPromises);
        }
      }

      // =========================
      // 4컷 스트립 합성
      // =========================
      function buildStripCanvas() {
        const canvas = stripCanvas;
        const ctx = canvas.getContext('2d');

        const stripWidth = 600;
        const stripHeight = 1800; // 1:3 비율
        canvas.width = stripWidth;
        canvas.height = stripHeight;

        // 배경: 프레임 이미지가 있으면 사용, 없으면 흰색
        if (frameBackgroundImg) {
          ctx.drawImage(frameBackgroundImg, 0, 0, stripWidth, stripHeight);
        } else {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, stripWidth, stripHeight);
        }

        console.log(
          `스트립 합성 시작: capturedCuts.length = ${capturedCuts.length}`
        );

        if (capturedCuts.length === 0) {
          ctx.fillStyle = '#9ca3af';
          ctx.font = '24px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(
            '촬영된 사진이 없습니다.',
            stripWidth / 2,
            stripHeight / 2
          );
          return;
        }

        const marginTop = 80;
        const marginBottom = 80;
        const verticalGap = 40;
        const availableHeight =
          stripHeight -
          marginTop -
          marginBottom -
          verticalGap * (TOTAL_CUTS - 1);
        const frameHeight = availableHeight / TOTAL_CUTS;
        const frameWidth = stripWidth * 0.8;
        const left = (stripWidth - frameWidth) / 2;

        for (let i = 0; i < TOTAL_CUTS; i++) {
          const top = marginTop + i * (frameHeight + verticalGap);

          // 개별 프레임 이미지가 있으면 사용, 없으면 기본 테두리
          const frameImg =
            frameImages[i] || (frameImages.length > 0 ? frameImages[0] : null);

          if (frameImg) {
            // 프레임 이미지 그리기
            ctx.drawImage(frameImg, left, top, frameWidth, frameHeight);
          } else {
            // 기본 프레임 테두리
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 8;
            ctx.strokeRect(left, top, frameWidth, frameHeight);
          }

          if (i < capturedCuts.length) {
            const image = capturedCuts[i];
            console.log(
              `프레임 ${i + 1} 그리기: image.width=${
                image.width
              }, image.height=${image.height}`
            );

            if (image.width > 0 && image.height > 0) {
              const imageRatio = image.width / image.height;
              const frameRatio = frameWidth / frameHeight;

              let drawWidth, drawHeight;
              if (imageRatio > frameRatio) {
                drawWidth = frameWidth;
                drawHeight = frameWidth / imageRatio;
              } else {
                drawHeight = frameHeight;
                drawWidth = frameHeight * imageRatio;
              }

              const dx = left + (frameWidth - drawWidth) / 2;
              const dy = top + (frameHeight - drawHeight) / 2;

              ctx.save();
              ctx.beginPath();
              ctx.rect(left, top, frameWidth, frameHeight);
              ctx.clip();
              ctx.drawImage(image, dx, dy, drawWidth, drawHeight);
              ctx.restore();
            } else {
              console.warn(`프레임 ${i + 1} 이미지 크기가 0입니다.`);
            }
          } else {
            console.warn(`프레임 ${i + 1}에 이미지가 없습니다.`);
          }
        }

        console.log(`스트립 합성 완료: 총 ${capturedCuts.length}장 사용`);
        stripImageUrl = canvas.toDataURL('image/png');
      }

      // =========================
      // GIF 생성 (gif.js)
      // =========================
      function buildGif() {
        return new Promise((resolve) => {
          if (gifFrames.length === 0) {
            resolve(null);
            return;
          }

          progressText.textContent = 'GIF를 생성하고 있어요...';

          const gif = new GIF({
            workers: 2,
            quality: 10,
            workerScript: './assets/gif/gif.worker.js',
          });

          gifFrames.forEach((frameCanvas) => {
            gif.addFrame(frameCanvas, { delay: GIF_SNAPSHOT_INTERVAL_MS });
          });

          gif.on('progress', (p) => {
            const percent = Math.round(p * 100);
            progressText.textContent = `GIF 생성 중... ${percent}%`;
          });

          gif.on('finished', (blob) => {
            if (gifUrl) URL.revokeObjectURL(gifUrl);
            gifUrl = URL.createObjectURL(blob);
            resolve(gifUrl);
          });

          gif.render();
        });
      }

      // =========================
      // 로딩 페이지에서 처리 시작
      // =========================
      async function startProcessing() {
        // 프레임 이미지 로드 (있는 경우)
        await loadFrameImages();

        // 4컷 스트립 먼저 합성
        buildStripCanvas();

        // GIF 생성
        const url = await buildGif();

        if (url) {
          loadingGifPreview.src = url;
          loadingGifPreview.classList.remove('hidden');
          progressText.textContent = '거의 다 됐어요!';
        } else {
          progressText.textContent =
            'GIF 생성에 실패했어요. 4컷 이미지만 제공됩니다.';
        }

        goResultBtn.disabled = false;
      }

      // =========================
      // 다운로드 & 공유
      // =========================
      function downloadStrip() {
        if (!stripImageUrl) return;
        const a = document.createElement('a');
        a.href = stripImageUrl;
        a.download = 'lifefourcut.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function downloadGif() {
        if (!gifUrl) {
          alert('GIF가 생성되지 않았어요.');
          return;
        }
        const a = document.createElement('a');
        a.href = gifUrl;
        a.download = 'lifefourcut.gif';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      async function shareResult() {
        if (!navigator.share) {
          alert('이 브라우저는 Web Share API를 지원하지 않습니다.');
          return;
        }
        try {
          await navigator.share({
            title: '인생네컷',
            text: '내가 찍은 인생네컷!',
            url: window.location.href, // 필요에 따라 수정
          });
        } catch (e) {
          console.log('공유 취소/오류:', e);
        }
      }

      // =========================
      // 초기화
      // =========================
      function resetAll() {
        capturedCuts = [];
        gifFrames = [];
        stripImageUrl = null;
        if (gifUrl) {
          URL.revokeObjectURL(gifUrl);
          gifUrl = null;
        }
        captureStatus.textContent = '카메라 준비 중입니다...';
        captureStartBtn.disabled = true;
      }

      // =========================
      // 이벤트 바인딩
      // =========================
      startBtn.addEventListener('click', () => {
        goToPage(PAGES.CAPTURE);
        startCamera();
      });

      captureStartBtn.addEventListener('click', () => {
        startAutoCaptureSession();
      });

      goResultBtn.addEventListener('click', () => {
        // 결과 페이지 세팅
        if (gifUrl) {
          resultGif.src = gifUrl;
        }
        goToPage(PAGES.RESULT);
      });

      downloadStripBtn.addEventListener('click', downloadStrip);
      downloadGifBtn.addEventListener('click', downloadGif);
      shareBtn.addEventListener('click', shareResult);

      restartBtn.addEventListener('click', () => {
        resetAll();
        goToPage(PAGES.INTRO);
      });

      // 페이지 로드 시
      window.addEventListener('beforeunload', () => {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
        }
        if (gifUrl) URL.revokeObjectURL(gifUrl);
      });
    </script>
  </body>
</html>
